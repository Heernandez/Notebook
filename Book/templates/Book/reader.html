{% extends "Book/base.html" %}
{% load static %}

{% block title %}{{ book.title }} Â· Reader{% endblock %}

{% block header %}
  <header class="topbar reader-topbar">
    <div class="reader-bar">
      <a class="reader-back" href="{% url 'Book:detail' book.pk %}" aria-label="Back">
        <img src="{% static 'back.png' %}" alt="" aria-hidden="true" />
      </a>
      <h1 class="reader-title">{{ book.title }}</h1>
      {% if user == book.owner and leaves %}
        <a class="reader-edit" href="{% url 'Book:edit_leaf' leaves.0.pk %}" data-edit-link>Edit</a>
      {% endif %}
    </div>
  </header>
{% endblock %}

{% block toolbar %}{% endblock %}
{% block main_class %}main-reader{% endblock %}
{% block body_class %}body-reader{% endblock %}

{% block content %}
  <section class="reader-shell reader-shell--full" data-reader>
    {% if leaves %}
      <div class="reader-track">
        {% for leaf in leaves %}
          <article class="reader-page" data-leaf-id="{{ leaf.pk }}">
            <div class="reader-leaf" data-leaf-id="{{ leaf.pk }}" data-leaf-text="{{ leaf.text|default:""|escapejs }}"></div>
            {% with script_id="leaf-json-"|add:leaf.pk %}
              {{ leaf.content_json|json_script:script_id }}
            {% endwith %}
          </article>
        {% endfor %}
      </div>
      <button class="reader-nav reader-prev" type="button" aria-label="Previous">Prev</button>
      <button class="reader-nav reader-next" type="button" aria-label="Next">Next</button>
    {% else %}
      <p class="empty-state">No leaves yet.</p>
    {% endif %}
  </section>
  <script type="module" src="{% static 'Book/leaf_reader.js' %}"></script>
  <script>
    (function () {
      var stage = document.querySelector("[data-reader]");
      if (!stage) return;
      var track = stage.querySelector(".reader-track");
      if (!track) return;
      var pages = track.querySelectorAll(".reader-page");
      var prev = stage.querySelector(".reader-prev");
      var next = stage.querySelector(".reader-next");
      var editLink = document.querySelector("[data-edit-link]");
      var index = 0;
      var startX = 0;
      var currentX = 0;
      var dragging = false;

      function update() {
        track.style.transform = "translateX(" + (-index * 100) + "%)";
        updateEditLink();
        resetFlip();
      }

      function updateEditLink() {
        if (!editLink) return;
        var page = pages[index];
        if (!page) return;
        var leafId = page.getAttribute("data-leaf-id");
        if (!leafId) return;
        editLink.href = "/leaves/" + leafId + "/edit/?leaf=" + leafId;
      }

      function clampIndex() {
        if (index < 0) index = 0;
        if (index >= pages.length) index = pages.length - 1;
      }

      function go(delta) {
        index += delta;
        clampIndex();
        update();
      }

      function onStart(clientX) {
        dragging = true;
        startX = clientX;
        currentX = clientX;
        track.classList.add("is-dragging");
        setTilting(true);
      }

      function onMove(clientX) {
        if (!dragging) return;
        currentX = clientX;
        var delta = currentX - startX;
        track.style.transform =
          "translateX(calc(" + (-index * 100) + "% + " + delta + "px))";
        applyFlip(delta);
      }

      function onEnd() {
        if (!dragging) return;
        var delta = currentX - startX;
        if (Math.abs(delta) > 60) {
          index += delta < 0 ? 1 : -1;
        }
        clampIndex();
        dragging = false;
        track.classList.remove("is-dragging");
        setTilting(false);
        update();
      }

      function setTilting(active) {
        var page = pages[index];
        if (!page) return;
        page.classList.toggle("is-tilting", active);
      }

      function resetFlip() {
        Array.prototype.forEach.call(pages, function (page) {
          page.style.transform = "";
          page.style.transformOrigin = "";
        });
      }

      function applyFlip(delta) {
        var page = pages[index];
        if (!page) return;
        var width = stage.clientWidth || 1;
        var progress = Math.max(-1, Math.min(1, delta / width));
        var angle = progress * -20;
        page.style.transformOrigin = progress < 0 ? "left center" : "right center";
        page.style.transform = "rotateY(" + angle + "deg)";
      }


      if (prev) prev.addEventListener("click", function () { go(-1); });
      if (next) next.addEventListener("click", function () { go(1); });

      stage.addEventListener("mousedown", function (event) {
        onStart(event.clientX);
      });
      window.addEventListener("mousemove", function (event) {
        onMove(event.clientX);
      });
      window.addEventListener("mouseup", function () {
        onEnd();
      });

      stage.addEventListener("touchstart", function (event) {
        if (event.touches.length === 1) {
          onStart(event.touches[0].clientX);
        }
      });
      stage.addEventListener("touchmove", function (event) {
        if (event.touches.length === 1) {
          onMove(event.touches[0].clientX);
        }
      });
      stage.addEventListener("touchend", function () {
        onEnd();
      });

      var params = new URLSearchParams(window.location.search);
      var leafParam = params.get("leaf");
      if (leafParam) {
        for (var i = 0; i < pages.length; i += 1) {
          if (pages[i].getAttribute("data-leaf-id") === leafParam) {
            index = i;
            break;
          }
        }
      }
      update();
    })();
  </script>
{% endblock %}
