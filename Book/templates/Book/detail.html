{% extends "Book/base.html" %}
{% load static social_status %}

{% block title %}Book · Note-Book{% endblock %}

{% block content %}
  <a class="reader-back" href="{% url 'Book:public_list' %}" aria-label="Back">
    <img src="{% static 'back.png' %}" alt="" aria-hidden="true" />
  </a>
  <section class="detail-layout">
    <div class="detail-cover">
      {% if book.cover_image %}
        <img src="{{ book.cover_image.url }}" alt="Cover for {{ book.title }}" />
      {% else %}
        <div class="cover-placeholder">No cover</div>
      {% endif %}
    </div>
    <div class="detail-info">
      <h1 class="detail-title">{{ book.title }}</h1>
      <h3 class="detail-author">{{ book.owner.first_name }} {{ book.owner.last_name }}</h3>
      <span class="detail-date">{{ book.created_at|date:"M Y" }}</span>
    </div>
  </section>
  <div class="detail-actions-row">
    <div class="detail-rating">
      {% if avg_rating %}
        <span class="detail-rating-top">
          <span class="rating-star" aria-hidden="true"></span>
          <span class="rating-value">{{ avg_rating|floatformat:1 }}</span>
        </span>
      {% else %}
        <span class="detail-rating-bottom">No ratings yet</span>
      {% endif %}
      <span class="detail-rating-bottom">{{ review_count }} review{% if review_count != 1 %}s{% endif %}</span>
    </div>
    <span class="detail-sep" aria-hidden="true">|</span>
    <span class="detail-pages">
      <span class="detail-pages-count">{{ leaves|length }}</span>
      <span class="detail-pages-label">page{% if leaves|length != 1 %}s{% endif %}</span>
    </span>
    <span class="detail-sep" aria-hidden="true">|</span>
    <a class="save-btn detail-read" href="{% url 'Book:reader' book.pk %}" aria-label="Read">
      <img src="{% static 'Book/read.png' %}" alt="" aria-hidden="true" />
    </a>
    <span class="detail-sep" aria-hidden="true">|</span>
    <form method="post" action="{% url 'Book:toggle_saved' book.pk %}">
      {% csrf_token %}
      <button
        class="save-btn"
        type="submit"
        aria-label="Save book"
        aria-pressed="{% if is_saved %}true{% else %}false{% endif %}"
      >
        <img
          src="{% if is_saved %}{% static 'Book/saved.png' %}{% else %}{% static 'Book/unsaved.png' %}{% endif %}"
          alt=""
          aria-hidden="true"
        />
      </button>
    </form>
    {% if user == book.owner %}
      <a class="save-btn detail-edit" href="{% url 'Book:edit' book.pk %}" aria-label="Edit">
        <img src="{% static 'Book/edit.svg' %}" alt="" aria-hidden="true" />
      </a>
      <a class="save-btn detail-add" href="{% url 'Book:add_leaf' book.pk %}" aria-label="Add leaf">
        <img src="{% static 'Book/add.png' %}" alt="" aria-hidden="true" />
      </a>
    {% endif %}
  </div>
  <section class="detail-about">
    <h2>About this notebook</h2>
    <p>{{ book.description|default:"No description yet" }}</p>
  </section>
  <section class="detail-reviews">
    <h2>Ratings and reviews</h2>
    {% if reviews %}
      <ul class="detail-review-list">
        {% for review in reviews|slice:":3" %}
          {% with reviewer_name=review.user.get_full_name|default:review.user.username|default:"Anonymous" %}
            <li class="detail-review-card">
              <div class="detail-review-header">
                {% user_avatar_url review.user as reviewer_avatar_url %}
                <span class="detail-review-avatar" aria-hidden="true">
                  {% if reviewer_avatar_url %}
                    <img src="{{ reviewer_avatar_url }}" alt="" />
                  {% else %}
                    {{ reviewer_name|slice:":1"|upper }}
                  {% endif %}
                </span>
                <span class="detail-review-name">{{ reviewer_name }}</span>
              </div>
              <div class="detail-review-meta">
                <span class="detail-review-stars">{{ review.rating }} ★</span>
                <span class="detail-review-date">{{ review.created_at|date:"d F Y" }}</span>
              </div>
              {% if review.comment %}
                <p class="detail-review-comment">{{ review.comment }}</p>
              {% endif %}
            </li>
          {% endwith %}
        {% endfor %}
      </ul>
    {% else %}
      <p class="detail-review-empty">No ratings yet. Be the first to review.</p>
    {% endif %}
    {% if user.is_authenticated %}
      <form class="detail-review-form" method="post" action="{% url 'Book:detail' book.pk %}" data-review-form>
        {% csrf_token %}
        <label class="detail-review-label" for="review-comment">Your review</label>
        <textarea
          id="review-comment"
          name="comment"
          maxlength="200"
          rows="3"
          placeholder="Share a short note about this notebook"
          required
        >{{ review_comment|default:"" }}</textarea>
        <div class="detail-review-stars-input" data-rating-input>
          <input type="hidden" name="rating" value="{{ review_rating|default:"" }}" />
          <button type="button" class="detail-star-button" data-value="1" aria-label="1 star">
            <span class="rating-star" aria-hidden="true"></span>
          </button>
          <button type="button" class="detail-star-button" data-value="2" aria-label="2 stars">
            <span class="rating-star" aria-hidden="true"></span>
          </button>
          <button type="button" class="detail-star-button" data-value="3" aria-label="3 stars">
            <span class="rating-star" aria-hidden="true"></span>
          </button>
          <button type="button" class="detail-star-button" data-value="4" aria-label="4 stars">
            <span class="rating-star" aria-hidden="true"></span>
          </button>
          <button type="button" class="detail-star-button" data-value="5" aria-label="5 stars">
            <span class="rating-star" aria-hidden="true"></span>
          </button>
        </div>
        <button class="detail-review-submit" type="submit" disabled>Send review</button>
        {% if review_error %}
          <p class="detail-review-error">{{ review_error }}</p>
        {% endif %}
      </form>
    {% else %}
      <a class="detail-review-submit" href="{% url 'account_login' %}">Comment</a>
    {% endif %}
  </section>
  <script>
    (function () {
      var form = document.querySelector("[data-review-form]");
      if (!form) return;
      var commentInput = form.querySelector("#review-comment");
      var ratingInput = form.querySelector("input[name='rating']");
      var starButtons = form.querySelectorAll(".detail-star-button");
      var submitBtn = form.querySelector(".detail-review-submit");

      function setStars(value) {
        Array.prototype.forEach.call(starButtons, function (button) {
          var starValue = parseInt(button.getAttribute("data-value"), 10);
          button.classList.toggle("is-active", starValue <= value);
        });
      }

      function updateSubmit() {
        var hasComment = commentInput.value.trim().length > 0;
        var hasRating = ratingInput.value.trim().length > 0;
        submitBtn.disabled = !(hasComment && hasRating);
      }

      Array.prototype.forEach.call(starButtons, function (button) {
        button.addEventListener("click", function () {
          ratingInput.value = button.getAttribute("data-value");
          setStars(parseInt(ratingInput.value, 10));
          updateSubmit();
        });
      });

      commentInput.addEventListener("input", updateSubmit);

      if (ratingInput.value) {
        setStars(parseInt(ratingInput.value, 10));
      }
      updateSubmit();
    })();
  </script>
{% endblock %}
{% block toolbar %}{% endblock %}
