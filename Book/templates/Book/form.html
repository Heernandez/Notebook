{% extends "Book/base.html" %}

{% block title %}
  {% if form.instance.pk %}Edit book{% else %}New book{% endif %}
{% endblock %}

{% block content %}
  <section class="form-shell">
    <div class="form-card">
      <h1>{% if form.instance.pk %}Edit book{% else %}New book{% endif %}</h1>
      <p>Save your notes, images, and ideas in one place.</p>
      <form method="post" enctype="multipart/form-data" class="form-grid" data-counter-form>
        {% csrf_token %}
        <div class="form-group">
          <label for="{{ form.title.id_for_label }}">Title</label>
          {{ form.title }}
          <div class="meta counter" data-counter-for="{{ form.title.id_for_label }}"></div>
        </div>
        <div class="form-group">
          <label for="{{ form.description.id_for_label }}">Description</label>
          {{ form.description }}
          <div class="meta counter" data-counter-for="{{ form.description.id_for_label }}"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.cover_image.id_for_label }}">Cover</label>
            <label class="cover-picker" for="{{ form.cover_image.id_for_label }}">
              {% if form.instance.cover_image %}
                <img src="{{ form.instance.cover_image.url }}" alt="Current cover" data-cover-preview />
                <span>Click to change cover</span>
              {% else %}
                <div class="cover-empty">
                  <span>Click to upload cover</span>
                </div>
              {% endif %}
            </label>
            {{ form.cover_image }}
            <div class="form-group inline-toggle">
              <label for="{{ form.is_public.id_for_label }}">Public</label>
              <div class="toggle">
                {{ form.is_public }}
                <span>Share with everyone</span>
              </div>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Save</button>
          <a class="btn btn-ghost" href="{% url 'Book:my_list' %}">Cancel</a>
        </div>
      </form>
    </div>
  </section>

  <script>
    (function () {
      function updateCounter(input, counter) {
        if (!input || !counter) return;
        var max = input.getAttribute("maxlength");
        if (!max) return;
        var length = (input.value || "").length;
        counter.textContent = length + " / " + max;
      }

      document.querySelectorAll("[data-counter-form]").forEach(function (form) {
        form.querySelectorAll(".counter").forEach(function (counter) {
          var id = counter.getAttribute("data-counter-for");
          var input = form.querySelector("#" + id);
          if (!input) return;
          updateCounter(input, counter);
          input.addEventListener("input", function () {
            updateCounter(input, counter);
          });
        });
      });
    })();
  </script>
  <script>
    (function () {
      var input = document.getElementById("{{ form.cover_image.id_for_label }}");
      var preview = document.querySelector("[data-cover-preview]");
      if (!input || !preview) return;
      input.addEventListener("change", function (event) {
        var file = event.target.files && event.target.files[0];
        if (!file) return;
        var url = URL.createObjectURL(file);
        preview.src = url;
        preview.alt = "New cover preview";
      });
    })();
  </script>
{% endblock %}
